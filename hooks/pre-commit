#!/bin/sh

# Temporary stash to hold the current state without the staged changes
echo "stashing changes"
git stash save -q --keep-index

# Function to clean up
cleanup() {
    if [ $? -ne 0 ]; then
        echo "somethig went wrong, falling back to stashed changes..."
        git stash pop -q
    else
        echo "cleaning up..."
        git stash drop -q
    fi
}
trap cleanup EXIT

FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.\(yaml\|yml\)$')

# Encrypt and replace each staged file
for file in $FILES; do
    # exclude .sops config file
    if echo "$file" | grep -Eq '\.sops\.y(a)?ml$'; then
        continue
    fi
    echo "encrypting file: $file"
    sops -e -i "$file"
    if [ $? -ne 0 ]; then
        exit 1
    fi
    git add "$file"
done

exit 0